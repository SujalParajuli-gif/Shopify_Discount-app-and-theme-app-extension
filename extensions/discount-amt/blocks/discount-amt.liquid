{%- comment -%}
  Discount block for product pages.

  What this block does:
  - Liquid gives us the current product and shop.
  - and we output:
      - product.id as data-product-id (numeric id from Shopify)
      - the selected variant price as data-product-price (no currency symbol)
      - shop.permanent_domain as data-shop-domain
      - our app tunnel URL as data-app-base-url
  - In JavaScript we turn the numeric product id into a GraphQL id:
      gid://shopify/Product/<numeric id>
  - The script calls /api/product-discount with shop and productId.
  - If the API returns a discount row, we:
      - show a "X% OFF" badge
      - calculate the discounted price from the base price and percentage
      - show both original and discounted prices inside this block.
{%- endcomment -%}

{%- assign app_base_url = "https://sites-answers-retention-certification.trycloudflare.com" -%}
{%- comment -%}
  Change this when the tunnel URL changes.
  Keep it without a trailing slash.
{%- endcomment -%}

<div
  id="discount-app-{{ block.id }}"
  class="discount-app-block"
  data-product-id="{{ product.id }}"
  data-shop-domain="{{ shop.permanent_domain }}"
  data-app-base-url="{{ app_base_url }}"
  data-product-price="{{ product.selected_or_first_available_variant.price | money_without_currency }}"
>
  {%- comment -%}
    These inner elements start empty.
    The JavaScript below will fill them after the API call.
  {%- endcomment -%}

  <div
    id="discount-app-badge-text-{{ block.id }}"
    style="font-size: 13px; color: #6b7280; margin-bottom: 4px;"
  >
    <!-- Discount badge will be inserted here -->
  </div>

  <div
    id="discount-app-price-text-{{ block.id }}"
    style="font-size: 14px; color: #111827;"
  >
    <!-- Original and discounted prices will be inserted here -->
  </div>
</div>

<script>
  (function () {
    // Build unique ids for this block instance.
    var wrapperId = "discount-app-{{ block.id }}";
    var badgeId = "discount-app-badge-text-{{ block.id }}";
    var priceId = "discount-app-price-text-{{ block.id }}";

    var wrapper = document.getElementById(wrapperId);
    if (!wrapper) {
      console.log("[discount-app] wrapper not found", wrapperId);
      return;
    }

    var badgeTarget = document.getElementById(badgeId);
    var priceTarget = document.getElementById(priceId);

    if (!badgeTarget || !priceTarget) {
      console.log("[discount-app] inner targets not found");
      return;
    }

    // Read values that Liquid stored as data attributes.
    var productNumericId = wrapper.dataset.productId;
    var shopDomain = wrapper.dataset.shopDomain;
    var appBaseUrl = wrapper.dataset.appBaseUrl;
    var rawPrice = wrapper.dataset.productPrice;

    // Turn the numeric product id into the GraphQL id format
    // so it matches the ids we stored in the database from the admin app.
    var productGid = null;
    if (productNumericId) {
      productGid = "gid://shopify/Product/" + productNumericId;
    }

    console.log("[discount-app] data", {
      productIdNumeric: productNumericId,
      productGid: productGid,
      shopDomain: shopDomain,
      appBaseUrl: appBaseUrl,
      productPrice: rawPrice,
    });

    // We at least need a product id, shop domain, and base URL.
    if (!productGid || !shopDomain || !appBaseUrl) {
      console.log("[discount-app] missing required id or shop data");
      return;
    }

    // Build the API URL for our Remix route.
    var url =
      appBaseUrl +
      "/api/product-discount?shop=" +
      encodeURIComponent(shopDomain) +
      "&productId=" +
      encodeURIComponent(productGid);

    console.log("[discount-app] fetching", url);

    // Call the app API and handle the JSON result.
    fetch(url)
      .then(function (res) {
        console.log("[discount-app] response status", res.status);
        return res.json();
      })
      .then(function (data) {
        console.log("[discount-app] response json", data);

        // No discount for this product, so we do not show anything.
        if (!data || !data.discount) {
          badgeTarget.innerHTML = "";
          priceTarget.innerHTML = "";
          console.log("[discount-app] no discount for this product");
          return;
        }

        var d = data.discount;
        var percentage = Number(d.percentage);

        if (Number.isNaN(percentage) || percentage <= 0) {
          console.log("[discount-app] invalid discount percentage", d.percentage);
          return;
        }

        // Show the badge whenever we have a valid percentage.
        badgeTarget.innerHTML =
          '<span style="display:inline-block; padding:4px 8px; border-radius:4px; background:black; color:white; font-size:13px;">' +
          percentage +
          "% OFF - " +
          d.title +
          "</span>";

        // If the price is missing we can still keep the badge.
        if (!rawPrice) {
          console.log("[discount-app] no product price provided, skipping price display");
          priceTarget.innerHTML = "";
          return;
        }

        // Turn the price text into a number.
        // money_without_currency can contain commas, so remove them first.
        var normalizedPrice = rawPrice.replace(/,/g, "").trim();
        var basePriceNumber = parseFloat(normalizedPrice);

        if (Number.isNaN(basePriceNumber)) {
          console.log("[discount-app] could not parse product price", rawPrice);
          priceTarget.innerHTML = "";
          return;
        }

        // Calculate the discounted price on the storefront side.
        var discounted = (basePriceNumber * (100 - percentage)) / 100;

        // Show both prices with two decimal places.
        var basePriceText = basePriceNumber.toFixed(2);
        var discountedText = discounted.toFixed(2);

        // Render the original price with a strike-through
        // and the discounted price next to it.
        priceTarget.innerHTML =
          '<span style="text-decoration: line-through; color: #6b7280; margin-right: 8px;">' +
          basePriceText +
          '</span>' +
          '<span style="font-weight: 600;">' +
          discountedText +
          "</span>";
      })
      .catch(function (err) {
        console.error("[discount-app] error loading discount", err);
      });
  })();
</script>

{% schema %}
{
  "name": "Discount Product",
  "target": "section",
  "settings": []
}
{% endschema %}
