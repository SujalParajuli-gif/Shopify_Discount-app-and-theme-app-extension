{%- assign app_base_url = "https://sites-answers-retention-certification.trycloudflare.com" -%}

{%- if block.settings.collection != blank -%}
  {%- assign discount_collection = block.settings.collection -%}

  <div class="discount-collection-grid" id="discount-collection-{{ block.id }}">
    {%- for product in discount_collection.products limit: block.settings.products_limit -%}
      <div
        class="discount-card"
        data-product-id="{{ product.id }}"
        data-shop-domain="{{ shop.permanent_domain }}"
        data-app-base-url="{{ app_base_url }}"
        data-product-price="{{ product.selected_or_first_available_variant.price | money_without_currency }}"
      >
        <a href="{{ product.url }}" style="text-decoration:none; color:inherit;">
          <div style="margin-bottom:8px;">
            {%- if product.featured_image -%}
              <img
                src="{{ product.featured_image | img_url: '360x' }}"
                alt="{{ product.featured_image.alt | escape }}"
                style="width:100%; display:block;"
              >
            {%- endif -%}
          </div>

          <div style="font-size:14px; margin-bottom:4px;">
            {{ product.title }}
          </div>

          <div
            class="discount-badge-target"
            style="font-size: 13px; color: #6b7280; margin-bottom: 4px;"
          ></div>

          <div
            class="discount-price-target"
            style="font-size: 14px; color: #111827;"
          ></div>
        </a>
      </div>
    {%- endfor -%}
  </div>

  <script>
    (function () {
      var grid = document.getElementById("discount-collection-{{ block.id }}");
      if (!grid) return;

      var cards = grid.querySelectorAll(".discount-card");
      if (!cards.length) return;

      cards.forEach(function (card) {
        var productNumericId = card.dataset.productId;
        var shopDomain = card.dataset.shopDomain;
        var appBaseUrl = card.dataset.appBaseUrl;
        var rawPrice = card.dataset.productPrice;

        // Build GraphQL product GID from numeric id.
        var productGid = productNumericId
          ? "gid://shopify/Product/" + productNumericId
          : null;

        if (!productGid || !shopDomain || !appBaseUrl) {
          console.log("[discount-app][collection] missing id/shop/app url");
          return;
        }

        var url =
          appBaseUrl +
          "/api/product-discount?shop=" +
          encodeURIComponent(shopDomain) +
          "&productId=" +
          encodeURIComponent(productGid);

        fetch(url)
          .then(function (res) {
            return res.json();
          })
          .then(function (data) {
            var badgeTarget = card.querySelector(".discount-badge-target");
            var priceTarget = card.querySelector(".discount-price-target");
            if (!badgeTarget || !priceTarget) return;

            if (!data || !data.discount) {
              badgeTarget.innerHTML = "";
              priceTarget.innerHTML = "";
              return;
            }

            var d = data.discount;
            var percentage = Number(d.percentage);
            if (Number.isNaN(percentage) || percentage <= 0) return;

            badgeTarget.innerHTML =
              '<span style="display:inline-block; padding:4px 8px; border-radius:4px; background:black; color:white; font-size:13px;">' +
              percentage +
              "% OFF - " +
              d.title +
              "</span>";

            if (!rawPrice) {
              priceTarget.innerHTML = "";
              return;
            }

            var normalizedPrice = rawPrice.replace(/,/g, "").trim();
            var basePriceNumber = parseFloat(normalizedPrice);
            if (Number.isNaN(basePriceNumber)) {
              priceTarget.innerHTML = "";
              return;
            }

            var discounted = (basePriceNumber * (100 - percentage)) / 100;
            var basePriceText = basePriceNumber.toFixed(2);
            var discountedText = discounted.toFixed(2);

            priceTarget.innerHTML =
              '<span style="text-decoration: line-through; color: #6b7280; margin-right: 8px;">' +
              basePriceText +
              '</span>' +
              '<span style="font-weight: 600;">' +
              discountedText +
              "</span>";
          })
          .catch(function (err) {
            console.error("[discount-app][collection] error", err);
          });
      });
    })();
  </script>
{%- endif -%}

{% schema %}
{
  "name": "Discount collection",
  "target": "section",
  "settings": [
    {
      "type": "collection",
      "id": "collection",
      "label": "Collection"
    },
    {
      "type": "range",
      "id": "products_limit",
      "label": "Number of products to show",
      "min": 1,
      "max": 12,
      "step": 1,
      "default": 4
    }
  ]
}
{% endschema %}
